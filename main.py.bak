import os
import re
import requests
import logging
from datetime import datetime
from bs4 import BeautifulSoup
from telethon import TelegramClient, events

# ====== CONFIG ======
api_id = 26652314
api_hash = '16e1dd8417c00068767fc6fc9a65f6b7'
target_group = -4820398082  # Group ID b·∫°n mu·ªën g·ª≠i video v√†o

# ====== TELETHON SETUP ======
client = TelegramClient('session', api_id, api_hash)
logging.basicConfig(level=logging.INFO, format='[%(levelname)s] %(message)s')

def log(msg):
    print(f'[üåÄ] {msg}')

# ====== DOWNLOAD FUNCTION ======
def download_file(url, filename):
    log(f'‚¨áÔ∏è ƒêang t·∫£i: {url}')
    try:
        with requests.get(url, stream=True) as r:
            r.raise_for_status()
            with open(filename, 'wb') as f:
                for chunk in r.iter_content(chunk_size=8192):
                    f.write(chunk)
        return True
    except Exception as e:
        log(f'L·ªói t·∫£i file: {e}')
        return False

# ====== PINTEREST EXTRACTOR ======
def extract_pinterest_media(pin_url):
    headers = {'User-Agent': 'Mozilla/5.0'}
    log(f'‚û° Chuy·ªÉn v·ªÅ link g·ªëc: {pin_url}')

    if 'pin.it' in pin_url:
        r = requests.get(pin_url, headers=headers)
        if r.status_code == 200:
            soup = BeautifulSoup(r.content, "html.parser")
            meta = soup.find("link", rel="alternate")
            if meta and 'url=' in meta['href']:
                match = re.search(r'url=(.*?)&', meta['href'])
                if match:
                    pin_url = match.group(1)
                    log(f'‚û° Link g·ªëc: {pin_url}')

    r = requests.get(pin_url, headers=headers)
    soup = BeautifulSoup(r.content, 'html.parser')

    video_tag = soup.find("video")
    if video_tag and 'src' in video_tag.attrs:
        video_url = video_tag['src']
        mp4_url = video_url.replace('/hls/', '/720p/').replace('.m3u8', '.mp4')
        return 'video', mp4_url

    img_tag = soup.find("img")
    if img_tag and 'src' in img_tag.attrs:
        return 'image', img_tag['src']

    return None, None

# ====== TELEGRAM COMMAND HANDLER ======
@client.on(events.NewMessage(pattern='/p '))
async def handler(event):
    try:
        link = event.raw_text.split(' ', 1)[1].strip()
        log(f'X·ª≠ l√Ω link: {link}')
        file_type, url = extract_pinterest_media(link)

        if not url:
            await event.reply("‚ùå Kh√¥ng t√¨m th·∫•y media trong link.")
            return

        filename = datetime.now().strftime("%d%m%H%M%S")
        if file_type == 'video':
            filename += '.mp4'
        elif file_type == 'image':
            filename += '.jpg'

        if download_file(url, filename):
            await client.send_file(target_group, filename, caption=f"üéâ T·∫£i t·ª´: {link}")
            os.remove(filename)
            log(f'üßπ ƒê√£ xo√° file: {filename}')
        else:
            await event.reply("‚ùå L·ªói khi t·∫£i ho·∫∑c g·ª≠i media.")

    except Exception as e:
        await event.reply(f"‚ùå ƒê√£ x·∫£y ra l·ªói: {e}")
        log(f'L·ªói: {e}')

# ====== START BOT ======
with client:
    log("ü§ñ Bot ƒë√£ ch·∫°y ‚Äî g·ª≠i /p <link Pinterest> ƒë·ªÉ t·∫£i video ho·∫∑c ·∫£nh.")
    client.run_until_disconnected()
